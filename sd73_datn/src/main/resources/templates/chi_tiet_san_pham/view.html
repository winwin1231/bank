<td>
            <strong th:text="${ct.tenCTSP}"></strong>
          </td>
          <td>
            <span class="badge badge-color" th:text="${ct.mauSac?.tenMau}"></span>
          </td>
          <td>
            <span class="badge badge-size" th:text="${ct.kichThuoc?.size}"></span>
          </td>
          <td>
            <span class="price-display" th:text="${#numbers.formatDecimal(ct.donGia, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
          </td>
          <td>
                <span th:text="${ct.soLuong}"
                      th:class="${ct.soLuong > 10 ? 'quantity-display quantity-high' : (ct.soLuong > 5 ? 'quantity-display quantity-medium' : 'quantity-display quantity-low')}"></span>
          </td>
          <td>
            <span th:text="${ct.ghiChu ?: '-'}" class="text-muted"></span>
          </td>
          <td>
                <span class="badge bg-success" th:if="${ct.trangThai == 1}">
                  <i class="bi bi-check-circle"></i> Còn bán
                </span>
            <span class="badge bg-secondary" th:if="${ct.trangThai != 1}">
                  <i class="bi bi-x-circle"></i> Ngừng bán
                </span>
          </td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-outline-primary" 
                      th:onclick="'editChiTiet(' + ${ct.id} + ')'" 
                      title="Chỉnh sửa nhanh">
                <i class="bi bi-pencil"></i>
              </button>
              <a th:href="@{'/chi-tiet-san-pham/delete/' + ${ct.id}}"
                 class="btn btn-sm btn-outline-danger"
                 onclick="return confirm('Bạn chắc chắn muốn xóa biến thể này?')" title="Xóa">
                <i class="bi bi-trash"></i>
              </a>
            </div>
          </td>
        </tr>
        <tr th:if="${#lists.isEmpty(listChiTiet)}">
          <td colspan="9">
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <h5>Chưa có biến thể nào</h5>
              <p class="text-muted">Hãy thêm biến thể đầu tiên cho sản phẩm này</p>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">
          <i class="bi bi-pencil-square"></i> Chỉnh sửa biến thể sản phẩm
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <input type="hidden" id="editId" name="id">
          <input type="hidden" id="editSanPhamId" name="sanPham.id">
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Mã chi tiết sản phẩm</label>
              <input type="text" class="form-control" id="editMaCTSP" name="maCTSP" placeholder="Nhập mã CTSP">
            </div>
            <div class="col-md-6">
              <label class="form-label">Tên chi tiết sản phẩm</label>
              <input type="text" class="form-control" id="editTenCTSP" name="tenCTSP" placeholder="Nhập tên CTSP">
            </div>
            <div class="col-md-6">
              <label class="form-label">Màu sắc <span class="required">*</span></label>
              <select class="form-select" id="editMauSac" name="mauSac.id" required>
                <option value="">-- Chọn màu sắc --</option>
                <option th:each="ms : ${listMauSac}" th:value="${ms.id}" th:text="${ms.tenMau}"></option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Kích thước <span class="required">*</span></label>
              <select class="form-select" id="editKichThuoc" name="kichThuoc.id" required>
                <option value="">-- Chọn kích thước --</option>
                <option th:each="kt : ${listKichThuoc}" th:value="${kt.id}" th:text="${kt.size}"></option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Đơn giá (VNĐ) <span class="required">*</span></label>
              <input type="number" class="form-control" id="editDonGia" name="donGia" min="0" step="1000" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Số lượng <span class="required">*</span></label>
              <input type="number" class="form-control" id="editSoLuong" name="soLuong" min="0" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Trạng thái</label>
              <select class="form-select" id="editTrangThai" name="trangThai">
                <option value="1">Còn bán</option>
                <option value="0">Ngừng bán</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ghi chú</label>
              <input type="text" class="form-control" id="editGhiChu" name="ghiChu" placeholder="Ghi chú thêm...">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Hủy
        </button>
        <button type="button" class="btn btn-primary" onclick="saveEdit()">
          <i class="bi bi-check-circle"></i> Lưu thay đổi
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Hiển thị loading overlay
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

// Ẩn loading overlay
function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// Hiển thị thông báo
function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Tự động ẩn sau 5 giây
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Mở modal chỉnh sửa
function editChiTiet(id) {
    showLoading();
    
    fetch(`/chi-tiet-san-pham/api/${id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Không thể tải dữ liệu');
            }
            return response.json();
        })
        .then(data => {
            // Điền dữ liệu vào form
            document.getElementById('editId').value = data.id;
            document.getElementById('editSanPhamId').value = data.sanPham.id;
            document.getElementById('editMaCTSP').value = data.maCTSP || '';
            document.getElementById('editTenCTSP').value = data.tenCTSP || '';
            document.getElementById('editDonGia').value = data.donGia || '';
            document.getElementById('editSoLuong').value = data.soLuong || '';
            document.getElementById('editGhiChu').value = data.ghiChu || '';
            document.getElementById('editTrangThai').value = data.trangThai || 1;
            
            // Set màu sắc và kích thước
            if (data.mauSac) {
                document.getElementById('editMauSac').value = data.mauSac.id;
            }
            if (data.kichThuoc) {
                document.getElementById('editKichThuoc').value = data.kichThuoc.id;
            }
            
            hideLoading();
            
            // Hiển thị modal
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        })
        .catch(error => {
            hideLoading();
            showAlert('Có lỗi xảy ra khi tải dữ liệu: ' + error.message, 'danger');
        });
}

// Lưu thay đổi
function saveEdit() {
    const form = document.getElementById('editForm');
    const formData = new FormData(form);
    
    // Chuyển FormData thành object
    const data = {};
    for (let [key, value] of formData.entries()) {
        if (key.includes('.')) {
            const [parent, child] = key.split('.');
            if (!data[parent]) data[parent] = {};
            data[parent][child] = value;
        } else {
            data[key] = value;
        }
    }
    
    showLoading();
    
    fetch('/chi-tiet-san-pham/api/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
        return response.text();
    })
    .then(message => {
        hideLoading();
        showAlert(message, 'success');
        
        // Đóng modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        modal.hide();
        
        // Reload trang sau 1 giây
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        hideLoading();
        showAlert('Có lỗi xảy ra: ' + error.message, 'danger');
    });
}

// Xử lý form validation
document.getElementById('editForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveEdit();
});
</script>
</body>
</html>